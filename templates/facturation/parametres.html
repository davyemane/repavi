{% extends 'base.html' %}
{% load static %}

{% block nav_facturation %}
flex items-center space-x-3 px-3 py-3 text-[#02066F] bg-[#02066F]/10 rounded-lg font-medium transition-all duration-300
{% endblock %}

{% block title %}Paramètres Facturation - RepAvi Lodges{% endblock %}
{% block page_title %}Paramètres de Facturation{% endblock %}
{% block page_subtitle %}Configuration générale des factures RepAvi{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'facturation:liste' %}" 
       class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors font-lato">
        <span class="material-icons text-sm mr-2">arrow_back</span>
        Retour
    </a>
</div>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    
    <!-- Affichage des messages d'erreur globaux -->
    {% if form.non_field_errors %}
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex">
                <span class="material-icons text-red-400 mr-2">error</span>
                <div class="flex-1">
                    <h3 class="text-sm font-medium text-red-800">Erreurs dans le formulaire</h3>
                    {% for error in form.non_field_errors %}
                        <p class="mt-1 text-sm text-red-700">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
    
    <form method="post" class="space-y-6" novalidate>
        {% csrf_token %}
        
        <!-- Informations Entreprise -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 font-lato">
                <span class="material-icons text-[#02066F] mr-2">business</span>
                Informations Entreprise
            </h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.nom_entreprise.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Nom de l'entreprise
                        {% if form.nom_entreprise.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                    </label>
                    {{ form.nom_entreprise }}
                    {% if form.nom_entreprise.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.nom_entreprise.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.telephone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Téléphone
                        {% if form.telephone.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                    </label>
                    {{ form.telephone }}
                    {% if form.telephone.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.telephone.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Email
                        {% if form.email.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                    </label>
                    {{ form.email }}
                    {% if form.email.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.email.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.site_web.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Site web (optionnel)
                    </label>
                    {{ form.site_web }}
                    {% if form.site_web.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.site_web.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mt-6">
                <label for="{{ form.adresse.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                    Adresse complète
                    {% if form.adresse.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                </label>
                {{ form.adresse }}
                {% if form.adresse.errors %}
                    <div class="mt-1 text-sm text-red-600">
                        {% for error in form.adresse.errors %}
                            <p class="flex items-center">
                                <span class="material-icons text-xs mr-1">error</span>
                                {{ error }}
                            </p>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Informations Fiscales -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 font-lato">
                <span class="material-icons text-[#02066F] mr-2">receipt_long</span>
                Informations Fiscales
            </h3>
            
            <div class="grid md:grid-cols-3 gap-6">
                <div>
                    <label for="{{ form.taux_tva_defaut.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Taux TVA par défaut (%)
                        {% if form.taux_tva_defaut.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                    </label>
                    {{ form.taux_tva_defaut }}
                    {% if form.taux_tva_defaut.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.taux_tva_defaut.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.numero_contribuable.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        N° Contribuable
                    </label>
                    {{ form.numero_contribuable }}
                    {% if form.numero_contribuable.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.numero_contribuable.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.numero_rccm.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        N° RCCM
                    </label>
                    {{ form.numero_rccm }}
                    {% if form.numero_rccm.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.numero_rccm.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Paramètres de Facturation -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 font-lato">
                <span class="material-icons text-[#02066F] mr-2">settings</span>
                Paramètres de Facturation
            </h3>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.frais_menage_defaut.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Frais de ménage par défaut (FCFA)
                    </label>
                    {{ form.frais_menage_defaut }}
                    {% if form.frais_menage_defaut.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.frais_menage_defaut.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.delai_paiement_jours.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Délai de paiement (jours)
                    </label>
                    {{ form.delai_paiement_jours }}
                    {% if form.delai_paiement_jours.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.delai_paiement_jours.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Textes par défaut -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 font-lato">
                <span class="material-icons text-[#02066F] mr-2">description</span>
                Textes par défaut
            </h3>
            
            <div class="space-y-6">
                <div>
                    <label for="{{ form.conditions_generales.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Conditions générales
                    </label>
                    {{ form.conditions_generales }}
                    {% if form.conditions_generales.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.conditions_generales.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.mentions_legales.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Mentions légales
                    </label>
                    {{ form.mentions_legales }}
                    {% if form.mentions_legales.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.mentions_legales.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div>
                    <label for="{{ form.footer_facture.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        Pied de page facture
                    </label>
                    {{ form.footer_facture }}
                    {% if form.footer_facture.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {% for error in form.footer_facture.errors %}
                                <p class="flex items-center">
                                    <span class="material-icons text-xs mr-1">error</span>
                                    {{ error }}
                                </p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end bg-white rounded-lg border border-gray-200 p-6">
            <button type="submit" 
                    class="inline-flex items-center px-8 py-3 bg-[#02066F] text-white rounded-lg hover:bg-[#030a8a] transition-colors font-medium font-lato">
                <span class="material-icons text-sm mr-2">save</span>
                Sauvegarder les paramètres
            </button>
        </div>
    </form>
</div>

<!-- Script pour améliorer l'UX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-scroll vers la première erreur si elle existe
    const firstError = document.querySelector('.text-red-600');
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Validation en temps réel pour certains champs
    const emailField = document.querySelector('input[type="email"]');
    const telephoneField = document.querySelector('input[type="tel"]');
    const urlField = document.querySelector('input[type="url"]');
    
    if (emailField) {
        emailField.addEventListener('blur', function() {
            if (this.value && !this.validity.valid) {
                this.classList.add('border-red-500');
            } else {
                this.classList.remove('border-red-500');
            }
        });
    }
    
    if (telephoneField) {
        telephoneField.addEventListener('input', function() {
            if (this.value && !this.value.startsWith('+')) {
                this.setCustomValidity('Le numéro doit commencer par +');
            } else {
                this.setCustomValidity('');
            }
        });
    }
    
    if (urlField) {
        urlField.addEventListener('blur', function() {
            if (this.value && !this.value.startsWith('http')) {
                this.value = 'https://' + this.value;
            }
        });
    }
});
</script>
{% endblock %}