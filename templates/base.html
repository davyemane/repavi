{% load static %}
<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RepAvi Lodges - Système de Gestion{% endblock %}</title>
    
    <!-- Favicon RepAvi -->
    <link rel="icon" type="image/svg+xml" href="{% static 'images/logorepavie.svg' %}">
    <link rel="alternate icon" href="{% static 'images/logorepavie.ico' %}">
    <link rel="apple-touch-icon" href="{% static 'images/logorepavie-180.png' %}">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'lato': ['Lato', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#02066F',
                        'primary-hover': '#030a8a',
                        'primary-light': '#02066F20',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Lato', sans-serif;
            background-image: url('{% static "images/logorepavie.svg" %}');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 25%;
            background-attachment: fixed;
            background-color: #f9fafb;
            position: relative;
        }
        
        /* Overlay pour atténuer le logo RepAvi */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(249, 250, 251, 0.85);
            z-index: -1;
            pointer-events: none;
        }
        
        /* Responsive du logo en arrière-plan */
        @media (max-width: 1024px) {
            body {
                background-size: 30%;
            }
        }
        
        @media (max-width: 768px) {
            body {
                background-size: 40%;
            }
        }
        
        @media (max-width: 480px) {
            body {
                background-size: 50%;
            }
        }
        
        /* Transparence pour les éléments */
        .bg-transparent-white {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2px);
        }
        
        .sidebar-bg {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(3px);
        }
        
        .header-bg {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(2px);
        }
        
        /* Animation subtile du logo (optionnel) */
        @media (prefers-reduced-motion: no-preference) {
            body {
                animation: breathe 12s ease-in-out infinite;
            }
            
            @keyframes breathe {
                0%, 100% {
                    background-size: 25%;
                }
                50% {
                    background-size: 26%;
                }
            }
            
            @media (max-width: 1024px) {
                @keyframes breathe {
                    0%, 100% { background-size: 30%; }
                    50% { background-size: 31%; }
                }
            }
            
            @media (max-width: 768px) {
                @keyframes breathe {
                    0%, 100% { background-size: 40%; }
                    50% { background-size: 41%; }
                }
            }
            
            @media (max-width: 480px) {
                @keyframes breathe {
                    0%, 100% { background-size: 50%; }
                    50% { background-size: 51%; }
                }
            }
        }
        
        /* Transition pour la sidebar */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        /* Overlay pour mobile */
        .sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Animation pour l'icône hamburger */
        .hamburger-line {
            transition: all 0.3s ease;
            transform-origin: center;
        }
        
        .hamburger-active .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }
        
        .hamburger-active .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-active .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }
        
        /* Amélioration des cartes avec transparence */
        .card-with-bg {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(1px);
        }
        
        /* Ombres personnalisées RepAvi */
        .shadow-repavi {
            box-shadow: 0 4px 6px -1px rgba(2, 6, 111, 0.1), 0 2px 4px -1px rgba(2, 6, 111, 0.06);
        }
        
        .shadow-repavi-lg {
            box-shadow: 0 10px 15px -3px rgba(2, 6, 111, 0.1), 0 4px 6px -2px rgba(2, 6, 111, 0.05);
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body class="h-full font-lato">
    <div class="flex h-screen overflow-hidden">
        
        <!-- Overlay pour mobile -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-75 z-40 lg:hidden sidebar-overlay opacity-0 invisible"></div>
        
        <!-- Fixed Sidebar -->
        <aside id="sidebar" class="w-64 sidebar-bg border-r border-gray-200 flex-shrink-0 fixed h-full z-50 sidebar-transition transform -translate-x-full lg:translate-x-0 shadow-repavi-lg">
            <div class="flex flex-col h-full">
                
                <!-- Logo Section -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-transparent-white">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#02066F] to-[#030a8a] rounded-lg flex items-center justify-center shadow-repavi">
                            <span class="material-icons text-white text-lg">home</span>
                        </div>
                        <div>
                            <h1 class="font-bold text-lg text-[#02066F] font-lato">RepAvi Lodges</h1>
                            <p class="text-xs text-gray-500 font-lato">Système de Gestion</p>
                        </div>
                    </div>
                    
                    <!-- Bouton fermer sur mobile -->
                    <button id="closeSidebar" class="lg:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors">
                        <span class="material-icons">close</span>
                    </button>
                </div>

                <!-- Navigation Menu -->
                <nav class="flex-1 overflow-y-auto py-4 px-3">
                    <div class="space-y-1">
                        <a href="{% url 'dashboard' %}" 
                           class="{% block nav_dashboard %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">dashboard</span>
                            <span class="font-lato">Dashboard</span>
                        </a>

                        <a href="{% url 'appartements:liste' %}"
                           class="{% block nav_appartements %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">apartment</span>
                            <span class="font-lato">Appartements</span>
                        </a>

                        <a href="{% url 'clients:liste' %}"
                           class="{% block nav_clients %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">people</span>
                            <span class="font-lato">Clients</span>
                        </a>

                        <a href="{% url 'reservations:calendrier' %}"
                           class="{% block nav_reservations %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">event</span>
                            <span class="font-lato">Réservations</span>
                            {% if reservations_aujourd_hui > 0 %}
                            <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">{{ reservations_aujourd_hui }}</span>
                            {% endif %}
                        </a>

                        <a href="{% url 'paiements:echeancier' %}"
                           class="{% block nav_paiements %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">payments</span>
                            <span class="font-lato">Paiements</span>
                            {% if paiements_retard > 0 %}
                            <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{{ paiements_retard }}</span>
                            {% endif %}
                        </a>

                        <!-- Divider -->
                        <div class="border-t border-gray-200 my-4"></div>

                        <a href="{% url 'inventaire:general' %}"
                           class="{% block nav_inventaire %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">inventory</span>
                            <span class="font-lato">Inventaire</span>
                        </a>

                        <a href="{% url 'menage:planning' %}"
                           class="{% block nav_menage %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">cleaning_services</span>
                            <span class="font-lato">Ménage</span>
                            {% if taches_menage_urgentes > 0 %}
                            <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">{{ taches_menage_urgentes }}</span>
                            {% endif %}
                        </a>

                        <a href="{% url 'comptabilite:rapport_mensuel' %}"
                           class="{% block nav_comptabilite %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">account_balance</span>
                            <span class="font-lato">Comptabilité</span>
                        </a>

                        <a href="{% url 'facturation:dashboard' %}"
                           class="{% block nav_facturation %}flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors{% endblock %}">
                            <span class="material-icons text-sm">receipt</span>
                            <span class="font-lato">Facturation</span>
                        </a>

                        <!-- Administration Section (Super Admin uniquement) -->
                        {% if user.profil == 'super_admin' %}
                        <div class="border-t border-gray-200 my-4"></div>
                        
                        <div class="px-3 py-2">
                            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider font-lato">
                                Administration
                            </h4>
                        </div>

                        <a href="{% url 'users:liste_gestionnaires' %}"
                           class="flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors">
                            <span class="material-icons text-sm">supervisor_account</span>
                            <span class="font-lato">Gestion Gestionnaires</span>
                            <span class="ml-auto bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded-full font-lato">Admin</span>
                        </a>

                        <a href="{% url 'users:historique' %}"
                           class="flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors">
                            <span class="material-icons text-sm">history</span>
                            <span class="font-lato">Historique Activités</span>
                        </a>
                        
                        <a href="{% url 'users:journal_actions' %}"
                           class="flex items-center space-x-3 px-3 py-3 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg">
                            <span class="material-icons text-sm">security</span>
                            <span class="font-lato">Journal d'audit</span>
                        </a>
                        {% endif %}
                    </div>
                </nav>

                <!-- User Menu -->
                <div class="border-t border-gray-200 p-4 bg-transparent-white">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#02066F] to-[#030a8a] rounded-full flex items-center justify-center shadow-repavi">
                            <span class="material-icons text-white text-sm">person</span>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900 font-lato">{{ user.first_name|default:user.username }}</p>
                            <p class="text-xs text-gray-500 font-lato">{{ user.get_profil_display }}</p>
                        </div>
                        <div class="relative group">
                            <button class="p-1 text-gray-400 hover:text-[#02066F] transition-colors">
                                <span class="material-icons text-sm">more_vert</span>
                            </button>
                            <div class="absolute bottom-full right-0 mb-2 w-48 bg-transparent-white border border-gray-200 rounded-lg shadow-repavi-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
                                <a href="{% url 'users:profil' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 first:rounded-t-lg transition-colors">
                                    <span class="material-icons text-sm">account_circle</span>
                                    <span class="font-lato">Mon Profil</span>
                                </a>
                                {% if user.profil == 'super_admin' %}
                                <a href="{% url 'users:liste_gestionnaires' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition-colors">
                                    <span class="material-icons text-sm">supervisor_account</span>
                                    <span class="font-lato">Gestionnaires</span>
                                </a>
                                <a href="{% url 'users:creer_gestionnaire' %}" class="flex items-center space-x-3 px-4 py-3 text-gray-600 hover:bg-gray-50 transition-colors">
                                    <span class="material-icons text-sm">person_add</span>
                                    <span class="font-lato">Nouveau Gestionnaire</span>
                                </a>
                                {% endif %}
                                <hr class="my-1">
                                <form action="{% url 'logout' %}" method="post" class="m-0">
                                    {% csrf_token %}
                                    <button type="submit" class="flex items-center space-x-3 px-4 py-3 text-red-600 hover:bg-red-50 last:rounded-b-lg w-full text-left transition-colors">
                                        <span class="material-icons text-sm">logout</span>
                                        <span class="font-lato">Déconnexion</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col lg:ml-64">
            
            <!-- Fixed Header -->
            <header class="header-bg border-b border-gray-200 px-6 py-4 fixed w-full z-20 lg:left-64 lg:w-[calc(100%-256px)] shadow-repavi">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- Bouton hamburger pour mobile -->
                        <button id="menuToggle" class="lg:hidden p-2 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors">
                            <div class="w-6 h-6 flex flex-col justify-center items-center space-y-1">
                                <span class="hamburger-line w-6 h-0.5 bg-current"></span>
                                <span class="hamburger-line w-6 h-0.5 bg-current"></span>
                                <span class="hamburger-line w-6 h-0.5 bg-current"></span>
                            </div>
                        </button>
                        
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900 font-lato">
                                {% block page_title %}Bonjour {{ user.first_name|default:user.username }} !{% endblock %}
                            </h1>
                            <p class="text-gray-600 font-lato">
                                {% block page_subtitle %}Voici un aperçu de votre activité{% endblock %}
                                {% if user.profil == 'super_admin' %}
                                <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                    Super Administrateur
                                </span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <div class="flex items-center space-x-3">
                        {% block header_actions %}
                        {% if user.profil == 'super_admin' %}
                        <a href="{% url 'users:creer_gestionnaire' %}"
                           class="hidden sm:inline-flex items-center px-4 py-2 border border-[#02066F] rounded-lg text-sm font-medium text-[#02066F] bg-[#02066F]/5 hover:bg-[#02066F]/10 transition-colors font-lato">
                            <span class="material-icons text-sm mr-2">person_add</span>
                            Nouveau Gestionnaire
                        </a>
                        {% endif %}
                        {% endblock %}

                        <button class="p-2 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors">
                            <span class="material-icons">notifications</span>
                        </button>

                        <button class="p-2 text-gray-600 hover:text-[#02066F] hover:bg-[#02066F]/10 rounded-lg transition-colors">
                            <span class="material-icons">refresh</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-y-auto pt-20">
                <div class="p-6 space-y-6">
                    
                    <!-- Messages -->
                    {% if messages %}
                        <div class="space-y-3">
                            {% for message in messages %}
                                <div class="bg-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-50 border border-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-200 text-{% if message.tags == 'error' %}red{% elif message.tags == 'warning' %}yellow{% elif message.tags == 'success' %}green{% else %}blue{% endif %}-800 px-4 py-3 rounded-lg flex items-center font-lato">
                                    <span class="material-icons mr-3 text-sm">
                                        {% if message.tags == 'error' %}error
                                        {% elif message.tags == 'warning' %}warning
                                        {% elif message.tags == 'success' %}check_circle
                                        {% else %}info{% endif %}
                                    </span>
                                    {{ message }}
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% block content %}
                    <div class="text-center py-12">
                        <h2 class="text-2xl font-bold text-gray-900 font-lato">Bienvenue sur RepAvi Lodges</h2>
                        <p class="text-gray-600 font-lato">Système de gestion hôtelière</p>
                    </div>
                    {% endblock %}
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Éléments DOM
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menuToggle');
            const closeSidebar = document.getElementById('closeSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // Fonction pour ouvrir la sidebar
            function openSidebar() {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('opacity-0', 'invisible');
                sidebarOverlay.classList.add('opacity-100', 'visible');
                menuToggle.classList.add('hamburger-active');
                document.body.classList.add('overflow-hidden'); // Empêche le scroll du body
            }

            // Fonction pour fermer la sidebar
            function closeSidebarFn() {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.remove('opacity-100', 'visible');
                sidebarOverlay.classList.add('opacity-0', 'invisible');
                menuToggle.classList.remove('hamburger-active');
                document.body.classList.remove('overflow-hidden');
            }

            // Event listeners
            menuToggle.addEventListener('click', function() {
                if (sidebar.classList.contains('-translate-x-full')) {
                    openSidebar();
                } else {
                    closeSidebarFn();
                }
            });

            closeSidebar.addEventListener('click', closeSidebarFn);
            sidebarOverlay.addEventListener('click', closeSidebarFn);

            // Fermer la sidebar avec Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !sidebar.classList.contains('-translate-x-full')) {
                    closeSidebarFn();
                }
            });

            // Gestion du redimensionnement de la fenêtre
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) { // lg breakpoint
                    // Sur desktop, s'assurer que la sidebar est visible
                    sidebar.classList.remove('-translate-x-full');
                    sidebarOverlay.classList.remove('opacity-100', 'visible');
                    sidebarOverlay.classList.add('opacity-0', 'invisible');
                    menuToggle.classList.remove('hamburger-active');
                    document.body.classList.remove('overflow-hidden');
                } else {
                    // Sur mobile, fermer la sidebar si elle est ouverte
                    if (!sidebar.classList.contains('-translate-x-full')) {
                        closeSidebarFn();
                    }
                }
            });
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>