{% extends 'base.html' %}
{% load static %}

{% block nav_comptabilite %}
flex items-center space-x-3 px-3 py-3 text-[#02066F] bg-[#02066F]/10 rounded-lg font-medium transition-all duration-300
{% endblock %}

{% block title %}Rapport Mensuel - {{ mois_nom }} - RepAvi Lodges{% endblock %}
{% block page_title %}Comptabilité - {{ mois_nom }}{% endblock %}
{% block page_subtitle %}Revenus et charges par appartement{% endblock %}

{% block header_actions %}
<div class="flex items-center space-x-3">
    <a href="{% url 'comptabilite:ajouter_mouvement' %}" 
       class="inline-flex items-center px-4 py-2 bg-[#02066F] text-white rounded-lg text-sm font-medium hover:bg-[#030a8a] transition-colors font-lato">
        <span class="material-icons text-sm mr-2">add</span>
        Ajouter Charge Manuelle
    </a>
    <a href="{% url 'comptabilite:export_rapport' annee mois %}" 
       class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors font-lato">
        <span class="material-icons text-sm mr-2">download</span>
        Export CSV
    </a>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    
    <!-- Explication du système automatique -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
        <div class="flex items-start space-x-3">
            <span class="material-icons text-blue-600 mt-1">info</span>
            <div>
                <h3 class="font-semibold text-blue-900 mb-2 font-lato">Système Automatique</h3>
                <div class="text-sm text-blue-800 space-y-1 font-lato">
                    <p><strong>Revenus :</strong> Créés automatiquement à chaque paiement effectué</p>
                    <p><strong>Charges :</strong> Créées automatiquement pour équipements défectueux (20% du prix) et hors service (80% du prix)</p>
                    <p><strong>Charges manuelles :</strong> Utilisez le bouton "Ajouter Charge Manuelle" pour ménage, réparations, etc.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres période -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <form method="GET" class="flex flex-wrap items-center gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 font-lato">Année</label>
                <select name="annee" class="px-3 py-2 border border-gray-300 rounded-lg font-lato">
{% for a in annees %}
<option value="{{ a }}" {% if a == annee %}selected{% endif %}>{{ a }}</option>
{% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1 font-lato">Mois</label>
                <select name="mois" class="px-3 py-2 border border-gray-300 rounded-lg font-lato">
{% for i in mois_liste %}
<option value="{{ i }}" {% if i == mois %}selected{% endif %}>
    {% if i == 1 %}Janvier{% elif i == 2 %}Février{% elif i == 3 %}Mars{% elif i == 4 %}Avril{% elif i == 5 %}Mai{% elif i == 6 %}Juin{% elif i == 7 %}Juillet{% elif i == 8 %}Août{% elif i == 9 %}Septembre{% elif i == 10 %}Octobre{% elif i == 11 %}Novembre{% else %}Décembre{% endif %}
</option>
{% endfor %}
                </select>
            </div>
            <button type="submit" class="px-4 py-2 bg-[#02066F] text-white rounded-lg font-lato mt-6">
                Filtrer
            </button>
        </form>
    </div>

    <!-- Résumé global -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-lato">Total Revenus</p>
                    <p class="text-2xl font-bold text-green-600 font-lato">{{ total_revenus|floatformat:0 }} FCFA</p>
                </div>
                <span class="material-icons text-green-600 text-3xl">trending_up</span>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-lato">Total Charges</p>
                    <p class="text-2xl font-bold text-red-600 font-lato">{{ total_charges|floatformat:0 }} FCFA</p>
                </div>
                <span class="material-icons text-red-600 text-3xl">trending_down</span>
            </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-lato">Résultat Net</p>
                    <p class="text-2xl font-bold {% if resultat_global >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-lato">
                        {{ resultat_global|floatformat:0 }} FCFA
                    </p>
                </div>
                <span class="material-icons {% if resultat_global >= 0 %}text-green-600{% else %}text-red-600{% endif %} text-3xl">
                    {% if resultat_global >= 0 %}account_balance_wallet{% else %}money_off{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Tableau par appartement -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900 font-lato">Détail par Appartement</h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Appartement
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Revenus Auto
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Charges Auto
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Résultat
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Occupation
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider font-lato">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for data in rapport_data %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <span class="material-icons text-[#02066F] mr-2">home</span>
                                <div>
                                    <div class="text-sm font-medium text-gray-900 font-lato">{{ data.appartement.numero }}</div>
                                    <div class="text-sm text-gray-500 font-lato">{{ data.appartement.get_type_logement_display }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-green-600 font-lato">{{ data.revenus|floatformat:0 }} FCFA</div>
                            <div class="text-xs text-gray-500 font-lato">Depuis paiements</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-red-600 font-lato">{{ data.charges|floatformat:0 }} FCFA</div>
                            <div class="text-xs text-gray-500 font-lato">Équipements + manuelles</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium {% if data.resultat >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-lato">
                                {{ data.resultat|floatformat:0 }} FCFA
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="text-sm font-medium text-gray-900 font-lato">{{ data.taux_occupation }}%</div>
                                <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-[#02066F] h-2 rounded-full" style="width: {{ data.taux_occupation }}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="{% url 'comptabilite:detail_appartement' data.appartement.pk %}?annee={{ annee }}&mois={{ mois }}" 
                               class="text-[#02066F] hover:text-[#030a8a] font-lato">
                                Détails
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 font-lato">
                            Aucun appartement trouvé
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock %}