<!-- ========================================== -->
<!-- templates/paiements/saisir.html - VERSION AMÉLIORÉE -->
<!-- ========================================== -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Saisir Paiement - RepAvi Lodges{% endblock %}

{% block page_title %}Saisir un paiement{% endblock %}
{% block page_subtitle %}Enregistrer un paiement reçu{% endblock %}

{% block header_actions %}
<a href="{% url 'paiements:echeancier' %}" 
   class="inline-flex items-center px-4 py-2 border border-[#02066F] text-[#02066F] rounded-lg text-sm font-medium hover:bg-[#02066F]/5 transition-colors font-lato">
    <span class="material-icons text-sm mr-2">arrow_back</span>
    Retour Échéancier
</a>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    
    <!-- Information de la réservation -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 font-lato">Informations de l'échéance</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2 font-lato">Réservation</h3>
                <div class="space-y-1">
                    <p class="text-sm text-gray-900 font-lato">Réservation #{{ reservation.id }}</p>
                    <p class="text-sm text-gray-600 font-lato">{{ reservation.appartement.numero }}</p>
                    <p class="text-sm text-gray-600 font-lato">
                        Du {{ reservation.date_arrivee|date:"d/m/Y" }} au {{ reservation.date_depart|date:"d/m/Y" }}
                    </p>
                </div>
            </div>
            
            <div>
                <h3 class="text-sm font-medium text-gray-700 mb-2 font-lato">Client</h3>
                <div class="space-y-1">
                    <p class="text-sm text-gray-900 font-lato">{{ reservation.client.prenom }} {{ reservation.client.nom }}</p>
                    <p class="text-sm text-gray-600 font-lato">{{ reservation.client.telephone }}</p>
                    <p class="text-sm text-gray-600 font-lato">{{ reservation.client.email|default:"Email non renseigné" }}</p>
                </div>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-1 font-lato">Type de paiement</h3>
                    <p class="text-lg font-semibold text-[#02066F] font-lato">{{ echeance.get_type_paiement_display }}</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-1 font-lato">Montant prévu</h3>
                    <p class="text-lg font-semibold text-gray-900 font-lato">{{ echeance.montant_prevu|floatformat:0 }} FCFA</p>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-1 font-lato">Date d'échéance</h3>
                    <p class="text-lg font-semibold {% if echeance.date_echeance < today %}text-red-600{% else %}text-gray-900{% endif %} font-lato">
                        {{ echeance.date_echeance|date:"d/m/Y" }}
                        {% if echeance.date_echeance < today %}
                        <span class="ml-2 px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-lato">En retard</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats rapides -->
    <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-lato">Montant Total Réservation</p>
                    <p class="text-xl font-bold text-gray-900 font-lato">{{ reservation.prix_total|floatformat:0 }} FCFA</p>
                </div>
                <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center">
                    <span class="material-icons text-gray-600 text-sm">receipt</span>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 font-lato">Déjà Payé</p>
                    <p class="text-xl font-bold text-green-600 font-lato">{{ situation.montant_paye|default:0|floatformat:0 }} FCFA</p>
                </div>
                <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <span class="material-icons text-green-600 text-sm">check_circle</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de saisie -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 font-lato">Détails du paiement reçu</h2>
        </div>

        <form method="post" class="p-6">
            {% csrf_token %}
            
            <div class="space-y-6">
                <!-- Montant payé -->
                <div>
                    <label for="{{ form.montant_paye.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        {{ form.montant_paye.label }}
                    </label>
                    {{ form.montant_paye }}
                    {% if form.montant_paye.errors %}
                        <div class="mt-1 text-sm text-red-600 font-lato">
                            {{ form.montant_paye.errors|first }}
                        </div>
                    {% endif %}
                    
                    <!-- Indicateur de solde en temps réel -->
                    <div id="solde-indicator" class="mt-3"></div>
                    
                    <!-- Message d'info sur le recalcul automatique -->
                    <div id="recalcul-info" class="mt-3 hidden">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-start space-x-2">
                                <span class="material-icons text-blue-600 text-sm mt-0.5">info</span>
                                <div class="text-sm text-blue-800 font-lato">
                                    <strong>Recalcul automatique activé</strong>
                                    <p class="mt-1">Le surplus sera automatiquement déduit de la prochaine échéance.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons de montant rapide -->
                    <div class="flex flex-wrap items-center gap-2 mt-3">
                        <span class="text-xs text-gray-500 font-lato">Montants rapides:</span>
                        <button type="button" onclick="setMontant({{ echeance.montant_prevu }})" 
                                class="px-3 py-1.5 bg-[#02066F] text-white text-xs rounded-lg hover:bg-[#030a8a] font-lato transition-colors">
                            Montant exact ({{ echeance.montant_prevu|floatformat:0 }})
                        </button>
                        <button type="button" onclick="setMontant({{ echeance.montant_prevu }} * 0.5)" 
                                class="px-3 py-1.5 bg-gray-100 text-gray-700 text-xs rounded-lg hover:bg-gray-200 font-lato transition-colors">
                            50%
                        </button>
                        <button type="button" onclick="setMontant(0)" 
                                class="px-3 py-1.5 bg-gray-100 text-gray-700 text-xs rounded-lg hover:bg-gray-200 font-lato transition-colors">
                            Effacer
                        </button>
                    </div>
                </div>

                <!-- Mode de paiement -->
                <div>
                    <label for="{{ form.mode_paiement.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        {{ form.mode_paiement.label }}
                    </label>
                    {{ form.mode_paiement }}
                    {% if form.mode_paiement.errors %}
                        <div class="mt-1 text-sm text-red-600 font-lato">
                            {{ form.mode_paiement.errors|first }}
                        </div>
                    {% endif %}
                </div>

                <!-- Commentaire -->
                <div>
                    <label for="{{ form.commentaire.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2 font-lato">
                        {{ form.commentaire.label }}
                    </label>
                    {{ form.commentaire }}
                    {% if form.commentaire.errors %}
                        <div class="mt-1 text-sm text-red-600 font-lato">
                            {{ form.commentaire.errors|first }}
                        </div>
                    {% endif %}
                    <p class="mt-1 text-sm text-gray-500 font-lato">
                        Ajoutez des détails sur le paiement (référence, observations, etc.)
                    </p>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between pt-6 mt-6 border-t border-gray-200">
                <a href="{% url 'paiements:echeancier' %}" 
                   class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors font-lato">
                    <span class="material-icons text-sm mr-2">arrow_back</span>
                    Retour
                </a>

                <div class="flex items-center space-x-3">
                    <button type="button" onclick="window.history.back()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors font-lato">
                        Annuler
                    </button>
                    
                    <button type="submit" id="submit-btn"
                            class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 transition-colors font-lato">
                        <span class="material-icons text-sm mr-2">save</span>
                        Enregistrer le paiement
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Calcul automatique du solde -->
    <div class="mt-6 bg-[#02066F]/5 rounded-lg p-4 border border-[#02066F]/20">
        <div class="flex items-start space-x-3">
            <span class="material-icons text-[#02066F] mt-0.5">info</span>
            <div>
                <h3 class="text-sm font-medium text-[#02066F] font-lato">Information</h3>
                <p class="text-sm text-[#02066F] mt-1 font-lato">
                    Le solde restant sera calculé automatiquement après enregistrement. 
                    La date de paiement sera automatiquement définie à aujourd'hui.
                    En cas de sur-paiement, le surplus sera automatiquement déduit de la prochaine échéance.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const montantInput = document.querySelector('input[name="montant_paye"]');
    const soldeIndicator = document.getElementById('solde-indicator');
    const recalculInfo = document.getElementById('recalcul-info');
    const submitBtn = document.getElementById('submit-btn');
    const montantPrevu = parseFloat({{ echeance.montant_prevu }});
    
    // Auto-focus
    if (montantInput) {
        montantInput.focus();
        montantInput.select();
    }

    // Fonction de validation en temps réel
    function updateSoldeIndicator() {
        if (!montantInput || !soldeIndicator) return;
        
        const montantSaisi = parseFloat(montantInput.value) || 0;
        const solde = montantPrevu - montantSaisi;
        
        // Reset classes
        montantInput.classList.remove('border-gray-300', 'border-orange-500', 'border-red-500', 'border-green-500');
        
        if (montantSaisi === 0) {
            soldeIndicator.innerHTML = '';
            if (recalculInfo) recalculInfo.classList.add('hidden');
            montantInput.classList.add('border-gray-300');
            submitBtn.disabled = false;
            
        } else if (montantSaisi < 0) {
            montantInput.classList.add('border-red-500');
            soldeIndicator.innerHTML = `
                <div class="flex items-center space-x-2 text-red-600 bg-red-50 rounded-lg p-3 border border-red-200">
                    <span class="material-icons text-sm">error</span>
                    <span class="text-sm font-lato font-semibold">Montant invalide : doit être positif</span>
                </div>
            `;
            if (recalculInfo) recalculInfo.classList.add('hidden');
            submitBtn.disabled = true;
            
        } else if (solde > 0) {
            montantInput.classList.add('border-orange-500');
            const pourcentage = Math.round((montantSaisi / montantPrevu) * 100);
            soldeIndicator.innerHTML = `
                <div class="flex items-center justify-between bg-orange-50 rounded-lg p-3 border border-orange-200">
                    <div class="flex items-center space-x-2 text-orange-700">
                        <span class="material-icons text-sm">info</span>
                        <div>
                            <span class="text-sm font-lato font-semibold">Paiement partiel (${pourcentage}%)</span>
                            <p class="text-xs font-lato mt-0.5">Reste à payer : ${solde.toLocaleString('fr-FR')} FCFA</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-16 h-2 bg-orange-200 rounded-full overflow-hidden">
                            <div class="h-full bg-orange-500 rounded-full" style="width: ${pourcentage}%"></div>
                        </div>
                    </div>
                </div>
            `;
            if (recalculInfo) recalculInfo.classList.add('hidden');
            submitBtn.disabled = false;
            
        } else if (solde < 0) {
            montantInput.classList.add('border-red-500');
            const surplus = Math.abs(solde);
            const pourcentage = Math.round((montantSaisi / montantPrevu) * 100);
            soldeIndicator.innerHTML = `
                <div class="flex items-center justify-between bg-red-50 rounded-lg p-3 border border-red-200">
                    <div class="flex items-center space-x-2 text-red-700">
                        <span class="material-icons text-sm animate-pulse">warning</span>
                        <div>
                            <span class="text-sm font-lato font-semibold">Sur-paiement détecté (${pourcentage}%)</span>
                            <p class="text-xs font-lato mt-0.5">Surplus : ${surplus.toLocaleString('fr-FR')} FCFA</p>
                        </div>
                    </div>
                </div>
            `;
            if (recalculInfo) recalculInfo.classList.remove('hidden');
            submitBtn.disabled = false;
            
        } else {
            montantInput.classList.add('border-green-500');
            soldeIndicator.innerHTML = `
                <div class="flex items-center space-x-2 bg-green-50 rounded-lg p-3 border border-green-200">
                    <span class="material-icons text-sm text-green-600">check_circle</span>
                    <span class="text-sm font-lato font-semibold text-green-700">✓ Montant exact payé</span>
                </div>
            `;
            if (recalculInfo) recalculInfo.classList.add('hidden');
            submitBtn.disabled = false;
        }
    }

    // Fonction globale pour boutons rapides
    window.setMontant = function(montant) {
        if (montantInput) {
            montantInput.value = Math.round(montant);
            updateSoldeIndicator();
            montantInput.focus();
        }
    };

    // Event listeners
    if (montantInput) {
        montantInput.addEventListener('input', updateSoldeIndicator);
        montantInput.addEventListener('keyup', updateSoldeIndicator);
    }
    
    // Validation initiale
    updateSoldeIndicator();
});
</script>
{% endblock %}